name: fdk-node
phoneBookId: functions
team: Functions
description: Node FDK
runnerTag: latest
version: 0 # Set by set_fdk_version and the setup_*_image steps, needs to be present here anyway
releaseBranches: ["master"]
triggerOnCommitBranches: ["pull-requests", "*"]

buildImageVersion: ""
runtimeImageVersion: ""
fdkVersion: ""

authCompartmentOcid: ocid1.compartment.oc1..aaaaaaaajnvcjjwfciaef2iaofrv5oq5yupxaivpzy7qrheify3lh42po27q
pipelineId: ocid1.devopsbuildpipeline.oc1.phx.amaaaaaaepf6idia4p7uas4hdpnp3ys5rcioarhlyjhovvvge4yzk64kpkwq

variables: {
    HTTP_PROXY: "http://www-proxy-hqdc.us.oracle.com:80"
    HTTPS_PROXY: "http://www-proxy-hqdc.us.oracle.com:80"
    NO_PROXY: "localhost,127.0.0.1,.us.oracle.com,.oraclecorp.com"
}

exportVariables {
    FDK_VERSION = "${set_fdk_version.fdk_version}"
}

steps: [
    ### Build FDK ###
    {
        name: set_fdk_version
        type: make
        makeCommands: [
            { target: "set_fdk_version", args: "-f internal/Makefile" }
        ]
        dotEnvFilePath: exportVariables.env
        artifacts: [
            "**"
        ]
    }
    {
        name: unit_test
        type: node
        dependsOn: set_fdk_version
        nodeVersion: "9"
        runnerImage: build-runner-node-ol8
        commands: [
            { command: "npm", args: "install" }
            { command: "npm", args: "run test" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: build_fdk
        type: node
        dependsOn: unit_test
        nodeVersion: "20.12.2"
        runnerImage: build-runner-node-ol8
        commands: [
            { command: "npm", args: "install" }
            { command: "npm", args: "pack" }
        ]
        artifacts: [
            "**"
        ]
    }
    # npm only allows a proper version number in package.json so that is left as the main fdk version
    # We need a unique artifact name to upload to artifactory though so this adds the build number and branch
    # suffix to the filename
    {
        name: fix_fdk_filename
        type: make
        dependsOn: build_fdk
        makeCommands: [
            { target: "fix_fdk_filename", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }

    ### Node 18 images ###
    {
        name: setup_node18_build_image
        type: make
        dependsOn: set_fdk_version
        environment: {
            NODE_VERSION: "18"
            FDK_VERSION: ${version}
            VERSION_SUFFIX: "dev"
        }
        makeCommands: [
            { target: "set_image_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: build_image_node18
        type: dockerizer
        dependsOn: setup_node18_build_image,
        dockerFile: "./internal/images/build-stage/18/Dockerfile"
        dockerBuildPwd: "./internal/images/build-stage/18"
        environment: {
            DOCKER_BUILDKIT: "1"
        }
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
        }
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_build_image_node18
        type: publishdocker
        skipOnDryRun: false
        dependsOn: build_image_node18
        imageName: "fdk-node"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
    # The individual build chains for each image can't be merged if the value of the version vaiable differs,
    # setting it back to the FDK version because that's the only bit that changes per build
    {
        name: fixup_version_build18
        type: make
        dependsOn: publish_build_image_node18
        makeCommands: [
            { target: "set_fdk_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: setup_node18_runtime_image
        type: make
        dependsOn: set_fdk_version
        environment: {
            NODE_VERSION: "18"
            FDK_VERSION: ${version}
        }
        makeCommands: [
            { target: "set_image_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: runtime_image_node18
        type: dockerizer
        dependsOn: setup_node18_runtime_image,
        dockerFile: "./internal/images/runtime/18/Dockerfile"
        dockerBuildPwd: "./internal/images/runtime/18"
        environment: {
            DOCKER_BUILDKIT: "1"
        }
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
        }
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_runtime_image_node18
        type: publishdocker
        skipOnDryRun: false
        dependsOn: runtime_image_node18
        imageName: "fdk-node"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
    # The individual build chains for each image can't be merged if the value of the version vaiable differs,
    # setting it back to the FDK version because that's the only bit that changes per build
    {
        name: fixup_version_runtime18
        type: make
        dependsOn: publish_runtime_image_node18
        makeCommands: [
            { target: "set_fdk_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: setup_test_image_build18
        type: make
        dependsOn: [fix_fdk_filename, fixup_version_build18, fixup_version_runtime18]
        environment: {
            NODE_VERSION: "18"
        }
        makeCommands: [
            { target: "setup_test_image_build", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: build_test_image_runtime_version_fn_18
        type: dockerizer
        dependsOn: setup_test_image_build18
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
            BUILD_IMAGE_VERSION: ${buildImageVersion}
            RUNTIME_IMAGE_VERSION: ${runtimeImageVersion}
            FDK_VERSION: ${fdkVersion}
        }
        dockerFile: "./internal/tests-images/node18/runtime-version-test/Build_file.bs"
        dockerBuildPwd: "./internal/tests-images/node18/runtime-version-test"
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_test_image_runtime_version_fn_18
        type: publishdocker
        skipOnDryRun: false
        dependsOn: build_test_image_runtime_version_fn_18
        imageName: "faas-runtime-version-fn"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }

    ### Node 20 images ###
    {
        name: setup_node20_build_image
        type: make
        dependsOn: set_fdk_version
        environment: {
            NODE_VERSION: "20"
            FDK_VERSION: ${version}
            VERSION_SUFFIX: "dev"
        }
        makeCommands: [
            { target: "set_image_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: build_image_node20
        type: dockerizer
        dependsOn: setup_node20_build_image,
        dockerFile: "./internal/images/build-stage/20/Dockerfile"
        dockerBuildPwd: "./internal/images/build-stage/20"
        environment: {
            DOCKER_BUILDKIT: "1"
        }
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
        }
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_build_image_node20
        type: publishdocker
        skipOnDryRun: false
        dependsOn: build_image_node20
        imageName: "fdk-node"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
    # The individual build chains for each image can't be merged if the value of the version vaiable differs,
    # setting it back to the FDK version because that's the only bit that changes per build
    {
        name: fixup_version_build20
        type: make
        dependsOn: publish_build_image_node20
        makeCommands: [
            { target: "set_fdk_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: setup_node20_runtime_image
        type: make
        dependsOn: set_fdk_version
        environment: {
            NODE_VERSION: "20"
            FDK_VERSION: ${version}
        }
        makeCommands: [
            { target: "set_image_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: runtime_image_node20
        type: dockerizer
        dependsOn: setup_node20_runtime_image,
        dockerFile: "./internal/images/runtime/20/Dockerfile"
        dockerBuildPwd: "./internal/images/runtime/20"
        environment: {
            DOCKER_BUILDKIT: "1"
        }
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
        }
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_runtime_image_node20
        type: publishdocker
        skipOnDryRun: false
        dependsOn: runtime_image_node20
        imageName: "fdk-node"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
    # The individual build chains for each image can't be merged if the value of the version vaiable differs,
    # setting it back to the FDK version because that's the only bit that changes per build
    {
        name: fixup_version_runtime20
        type: make
        dependsOn: publish_runtime_image_node20
        makeCommands: [
            { target: "set_fdk_version", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: setup_test_image_build20
        type: make
        dependsOn: [fix_fdk_filename, fixup_version_build20, fixup_version_runtime20]
        environment: {
            NODE_VERSION: "20"
        }
        makeCommands: [
            { target: "setup_test_image_build", args: "-f internal/Makefile" }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: build_test_image_hello_world_fn_20
        type: dockerizer
        dependsOn: setup_test_image_build20
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
            BUILD_IMAGE_VERSION: ${buildImageVersion}
            RUNTIME_IMAGE_VERSION: ${runtimeImageVersion}
            FDK_VERSION: ${fdkVersion}
        }
        dockerFile: "./internal/tests-images/node20/hello-world-test/Build_file.bs"
        dockerBuildPwd: "./internal/tests-images/node20/hello-world-test"
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_test_image_hello_world_fn_20
        type: publishdocker
        skipOnDryRun: false
        dependsOn: build_test_image_hello_world_fn_20
        imageName: "faas-hello-world-fn"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
    {
        name: build_test_image_oci_sdk_fn_20
        type: dockerizer
        dependsOn: setup_test_image_build20
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
            BUILD_IMAGE_VERSION: ${buildImageVersion}
            RUNTIME_IMAGE_VERSION: ${runtimeImageVersion}
            FDK_VERSION: ${fdkVersion}
        }
        dockerFile: "./internal/tests-images/node20/oci-sdk-test/Build_file.bs"
        dockerBuildPwd: "./internal/tests-images/node20/oci-sdk-test"
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_test_image_oci_sdk_fn_20
        type: publishdocker
        skipOnDryRun: false
        dependsOn: build_test_image_oci_sdk_fn_20
        imageName: "faas-oci-sdk-fn"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
    {
        name: build_test_image_runtime_version_fn_20
        type: dockerizer
        dependsOn: setup_test_image_build20
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
            BUILD_IMAGE_VERSION: ${buildImageVersion}
            RUNTIME_IMAGE_VERSION: ${runtimeImageVersion}
            FDK_VERSION: ${fdkVersion}
        }
        dockerFile: "./internal/tests-images/node20/runtime-version-test/Build_file.bs"
        dockerBuildPwd: "./internal/tests-images/node20/runtime-version-test"
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_test_image_runtime_version_fn_20
        type: publishdocker
        skipOnDryRun: false
        dependsOn: build_test_image_runtime_version_fn_20
        imageName: "faas-runtime-version-fn"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
    {
        name: build_test_image_timeout_fn_20
        type: dockerizer
        dependsOn: setup_test_image_build20
        dockerBuildArgs: {
            HTTP_PROXY: ${HTTP_PROXY}
            HTTPS_PROXY: ${HTTPS_PROXY}
            NO_PROXY: ${NO_PROXY}
            BUILD_IMAGE_VERSION: ${buildImageVersion}
            RUNTIME_IMAGE_VERSION: ${runtimeImageVersion}
            FDK_VERSION: ${fdkVersion}
        }
        dockerFile: "./internal/tests-images/node20/timeout-test/Build_file.bs"
        dockerBuildPwd: "./internal/tests-images/node20/timeout-test"
        images : [
            {
                platform: "linux/x86_64"
            },
            {
                platform: "linux/arm64"
            }
        ]
        artifacts: [
            "**"
        ]
    }
    {
        name: publish_test_image_timeout_fn_20
        type: publishdocker
        skipOnDryRun: false
        dependsOn: build_test_image_timeout_fn_20
        imageName: "faas-timeout-fn"
        repository: odo-docker-signed-local
        artifacts: [
            "**"
        ]
    }
]
ARG NODE_VERSION=latest
ARG OCIR_REGION=OCIR_REGION
ARG OCIR_LOC=OCIR_LOC
ARG BUILD_VERSION=BUILD_VERSION

FROM ${OCIR_REGION}/${OCIR_LOC}/nodefdk:${NODE_VERSION}-${BUILD_VERSION}-dev as build-stage

ARG PKG_VERSION="1.0.0-SNAPSHOT"
WORKDIR /function
RUN echo $'registry=https://artifactory.oci.oraclecorp.com/api/npm/global-release-npm \n@types:registry=https://artifactory.oci.oraclecorp.com/api/npm/global-release-npm \nstrict-ssl=false'> ~/.npmrc
COPY fnproject-fdk-${PKG_VERSION}.tgz /function/
ADD package.json /function/
RUN npm install fnproject-fdk-${PKG_VERSION}.tgz
RUN npm install
FROM ${OCIR_REGION}/${OCIR_LOC}/nodefdk:${NODE_VERSION}-${BUILD_VERSION}
ARG PKG_VERSION="1.0.0-SNAPSHOT"
WORKDIR /function
ADD . /function/
RUN rm -rf fnproject-fdk-${PKG_VERSION}.tgz Build_file
COPY --from=build-stage /function/node_modules/ /function/node_modules/
RUN chmod -R o+r /function
ENTRYPOINT ["node", "func.js"]
